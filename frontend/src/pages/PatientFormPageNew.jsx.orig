
import React, { useState, useEffect, useCallback } from 'react'
import { useParams, useNavigate } from 'react-router-dom'
import { patientService } from '../services/patientService'
import { dictionaryService } from '../services/dictionaryService'
import PatientFormSidebar from '../components/PatientFormSidebar'
import DateValidation from '../components/DateValidation'
import TNMSelect from '../components/TNMSelect'
import './PatientFormPageNew.css'

function PatientFormPageNew({ user }) {
  const { id } = useParams()
  const navigate = useNavigate()
  const isEdit = !!id

  const [loading, setLoading] = useState(false)
  const [saving, setSaving] = useState(false)
  const [error, setError] = useState('')
  const [dictionaries, setDictionaries] = useState({})
  const [currentSection, setCurrentSection] = useState('current-status')
  const [autoSaveTimer, setAutoSaveTimer] = useState(null)
  
  // Form sections definition (merged sections as requested)
  const sections = [
    { id: 'current-status', title: '–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å', icon: 'üìä' },
    { id: 'patient-basic', title: '–ö–æ–¥ –ø–∞—Ü–∏–µ–Ω—Ç–∞ –∏ –±–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ', icon: 'üë§' },
    { id: 'diagnosis-alk', title: '–î–∏–∞–≥–Ω–æ–∑ –∏ ALK –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞', icon: 'üîç' },
    { id: 'previous-therapy', title: '–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Ç–µ—Ä–∞–ø–∏—è', icon: 'üíä' },
    { id: 'alectinib-complete', title: '–õ–µ—á–µ–Ω–∏–µ –∞–ª–µ–∫—Ç–∏–Ω–∏–±–æ–º', icon: 'üéØ' },
    { id: 'next-line', title: '–°–ª–µ–¥—É—é—â–∞—è –ª–∏–Ω–∏—è', icon: '‚û°Ô∏è' }
  ]
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã —Å –Ω–æ–≤—ã–º–∏ –ø–æ–ª—è–º–∏
  const [formData, setFormData] = useState({
    // NEW FIELDS
    patient_code: '',
    date_filled: new Date().toISOString().split('T')[0],
    
    // Current status (moved to top)
    current_status: '',
    last_contact_date: '',
    
    // –ë–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    gender: '',
    birth_date: '',
    height: '',
    weight: '',
    comorbidities: [],
    smoking_status: '', // Now dropdown
    
    // –î–∏–∞–≥–Ω–æ–∑
    initial_diagnosis_date: '',
    tnm_stage: '',
    metastatic_disease_date: '',
    histology: '',
    
    // ALK
    alk_diagnosis_date: '',
    alk_methods: [],
    alk_fusion_variant: '',
    tp53_comutation: '',
    ttf1_expression: '',
    
    // –ü—Ä–µ–¥—ã–¥—É—â–∞—è —Ç–µ—Ä–∞–ø–∏—è
    had_previous_therapy: false,
    no_previous_therapy: false, // NEW
    previous_therapy_types: [],
    previous_therapy_start_date: '',
    previous_therapy_end_date: '',
    previous_therapy_response: '',
    previous_therapy_stop_reason: '',
    
    // –ê–ª–µ–∫—Ç–∏–Ω–∏–±
    alectinib_start_date: '',
    stage_at_alectinib_start: '',
    ecog_at_start: '',
    metastases_sites: [],
    cns_metastases: false,
    cns_measurable: '',
    cns_symptomatic: '',
    cns_radiotherapy: '',
    
    // –û—Ç–≤–µ—Ç (CHANGED: single field instead of first/second control)
    maximum_response: '',
    earliest_response_date: '',
    intracranial_response: '',
    
    // –ü—Ä–æ–≥—Ä–µ—Å—Å–∏—Ä–æ–≤–∞–Ω–∏–µ
    progression_during_alectinib: '',
    local_treatment_at_progression: '',
    progression_sites: [],
    progression_date: '',
    continued_after_progression: false,
    
    // –û–∫–æ–Ω—á–∞–Ω–∏–µ
    alectinib_end_date: '',
    alectinib_stop_reason: '',
    had_treatment_interruption: false,
    interruption_reason: '',
    interruption_duration_months: '',
    had_dose_reduction: false,
    
    // –°–ª–µ–¥. –ª–∏–Ω–∏—è
    next_line_treatments: [],
    next_line_start_date: '',
    progression_on_next_line: false,
    progression_on_next_line_date: '',
    next_line_end_date: '',
    total_lines_after_alectinib: '',
  })

  useEffect(() => {
    loadDictionaries()
    if (isEdit) {
      loadPatient()
    }
  }, [id])

  const loadDictionaries = async () => {
    try {
      const data = await dictionaryService.getDictionaries()
      const grouped = {}
      data.forEach(item => {
        if (!grouped[item.category]) {
          grouped[item.category] = []
        }
        grouped[item.category].push(item)
      })
      setDictionaries(grouped)
    } catch (err) {
      console.error('Error loading dictionaries:', err)
    }
  }

  const loadPatient = async () => {
    try {
      setLoading(true)
      const patient = await patientService.getPatient(id)
      if (patient.clinical_record) {
        const cr = { ...patient.clinical_record }
        // Convert dates
        const dateFields = [
          'birth_date', 'initial_diagnosis_date', 'metastatic_disease_date',
          'alk_diagnosis_date', 'previous_therapy_start_date', 'previous_therapy_end_date',
          'alectinib_start_date', 'earliest_response_date', 'progression_date',
          'alectinib_end_date', 'next_line_start_date', 'progression_on_next_line_date',
          'next_line_end_date', 'last_contact_date', 'date_filled'
        ]
        dateFields.forEach(field => {
          if (cr[field]) {
            cr[field] = cr[field].split('T')[0]
          }
        })
        setFormData(cr)
      }
    } catch (err) {
      setError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–∞—Ü–∏–µ–Ω—Ç–∞')
    } finally {
      setLoading(false)
    }
  }

  // Auto-save functionality
  const autoSave = useCallback(async (changedFields) => {
    if (!isEdit) return
    
    try {
      const response = await fetch(`/api/patients/${id}/auto-save`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify(changedFields)
      })
      
      if (response.ok) {
        console.log('Auto-saved:', Object.keys(changedFields))
      }
    } catch (err) {
      console.error('Auto-save error:', err)
    }
  }, [id, isEdit])

  const handleChange = (e) => {
    const { name, value, type, checked } = e.target
    const newValue = type === 'checkbox' ? checked : value
    
    setFormData(prev => {
      const updated = { ...prev, [name]: newValue }
      
      // Auto-save logic - debounced
      if (isEdit) {
        if (autoSaveTimer) {
          clearTimeout(autoSaveTimer)
        }
        
        const timer = setTimeout(() => {
          autoSave({ [name]: newValue })
        }, 1000) // 1 second delay
        
        setAutoSaveTimer(timer)
      }
      
      return updated
    })
    
    // Special logic for CNS metastases auto-check
    if (name === 'metastases_sites') {
      const sites = Array.isArray(value) ? value : (formData.metastases_sites || [])
      if (sites.includes('CNS')) {
        setFormData(prev => ({ ...prev, cns_metastases: true }))
      }
    }
    
    // Logic for no previous therapy
    if (name === 'no_previous_therapy' && checked) {
      setFormData(prev => ({ 
        ...prev, 
        had_previous_therapy: false,
        previous_therapy_types: [],
        previous_therapy_start_date: '',
        previous_therapy_end_date: '',
        previous_therapy_response: '',
        previous_therapy_stop_reason: ''
      }))
    }
  }

  const handleMultiSelect = (name, value) => {
    setFormData(prev => {
      const currentValues = prev[name] || []
      const newValues = currentValues.includes(value)
        ? currentValues.filter(v => v !== value)
        : [...currentValues, value]
      
      const updated = { ...prev, [name]: newValues }
      
      // Auto-check CNS metastases when –¶–ù–° is selected
      if (name === 'metastases_sites' && newValues.includes('CNS')) {
        updated.cns_metastases = true
      }
      
      // Auto-save
      if (isEdit) {
        if (autoSaveTimer) clearTimeout(autoSaveTimer)
        const timer = setTimeout(() => autoSave({ [name]: newValues }), 1000)
        setAutoSaveTimer(timer)
      }
      
      return updated
    })
  }

  const handleSubmit = async (e) => {
  e.preventDefault()
  setSaving(true)
  setError('')

  try {
    // Prepare dates - ensure they are in correct format
    const preparedData = { ...formData }
    
    // Convert empty strings to null for optional date fields
    const dateFields = [
      'birth_date', 'initial_diagnosis_date', 'metastatic_disease_date',
      'alk_diagnosis_date', 'previous_therapy_start_date', 'previous_therapy_end_date',
      'alectinib_start_date', 'earliest_response_date', 'progression_date',
      'alectinib_end_date', 'next_line_start_date', 'progression_on_next_line_date',
      'next_line_end_date', 'last_contact_date', 'date_filled'
    ]
    
    dateFields.forEach(field => {
      if (preparedData[field] === '') {
        preparedData[field] = null
      }
      else if (preparedData[field] && !preparedData[field].includes('T')) {
        // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è 00:00:00, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
        preparedData[field] = preparedData[field] + 'T00:00:00'
      }
    })
    
    // Convert empty arrays to null or remove them
    const arrayFields = [
      'comorbidities', 'alk_methods', 'previous_therapy_types',
      'metastases_sites', 'progression_sites', 'next_line_treatments'
    ]
    
    arrayFields.forEach(field => {
      if (!preparedData[field] || preparedData[field].length === 0) {
        preparedData[field] = []
      }
    })
    
    // Convert numeric strings to numbers
    const numericFields = ['height', 'weight', 'ecog_at_start', 'interruption_duration_months', 'total_lines_after_alectinib']
    numericFields.forEach(field => {
      if (preparedData[field] === '') {
        preparedData[field] = null
      } else if (preparedData[field]) {
        preparedData[field] = parseFloat(preparedData[field])
      }
    })

    const payload = {
      clinical_record: preparedData
    }

    console.log('Sending payload:', JSON.stringify(payload, null, 2)) // Debug log

    if (isEdit) {
      await patientService.updatePatient(id, payload)
    } else {
      const result = await patientService.createPatient(payload)
      // For new patient, navigate to edit mode instead of patients list
      if (result?.id) {
        navigate(`/patients/${result.id}`)
        return
      }
    }

    // Navigate to the next section or patients list
    const currentIndex = sections.findIndex(s => s.id === currentSection)
    if (currentIndex < sections.length - 1) {
      // Move to next section
      const nextSection = sections[currentIndex + 1].id
      setCurrentSection(nextSection)
    } else {
      // Last section, navigate to patients list
      navigate('/patients')
    }
  } catch (err) {
    console.error('Submit error:', err) // Debug log
    const errorMessage = err.response?.data?.detail || err.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'
    setError(typeof errorMessage === 'string' ? errorMessage : JSON.stringify(errorMessage))
  } finally {
    setSaving(false)
  }
}

  // Date validation rules
  const dateValidationRules = {
    alk_diagnosis_date: [
      {
        type: 'before',
        compareWith: 'initial_diagnosis_date',
        message: '–î–∞—Ç–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ ALK –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –¥–∏–∞–≥–Ω–æ–∑–∞'
      }
    ],
    birth_date: [
      {
        type: 'after',
        compareWith: 'initial_diagnosis_date',
        message: '–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–∑–∂–µ –¥–∞—Ç—ã –¥–∏–∞–≥–Ω–æ–∑–∞'
      }
    ],
    previous_therapy_end_date: [
      {
        type: 'before',
        compareWith: 'previous_therapy_start_date',
        message: '–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞'
      }
    ],
    alectinib_end_date: [
      {
        type: 'before',
        compareWith: 'alectinib_start_date',
        message: '–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞'
      }
    ]
  }

  const renderMultiSelect = (name, category, label) => {
    const options = dictionaries[category] || []
    const selected = formData[name] || []
    
    return (
      <div className="form-group">
        <label className="form-label">{label}</label>
        <div className="checkbox-group">
          {options.map(opt => (
            <label key={opt.id} className="checkbox-label">
              <input
                type="checkbox"
                checked={selected.includes(opt.code)}
                onChange={() => handleMultiSelect(name, opt.code)}
              />
              <span>{opt.value_ru}</span>
            </label>
          ))}
        </div>
      </div>
    )
  }

  const renderSelect = (name, category, label, required = false) => {
    const options = dictionaries[category] || []
    
    return (
      <div className="form-group">
        <label className="form-label">
          {label}
          {required && <span className="required">*</span>}
        </label>
        <select
          name={name}
          value={formData[name]}
          onChange={handleChange}
          className="form-select"
          required={required}
        >
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
          {options.map(opt => (
            <option key={opt.id} value={opt.code}>
              {opt.value_ru}
            </option>
          ))}
        </select>
      </div>
    )
  }

  const renderSection = () => {
    switch(currentSection) {
      case 'current-status':
        return (
          <div className="card">
            <h3>–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –ø–∞—Ü–∏–µ–Ω—Ç–∞</h3>
            <div className="grid grid-2">
              {renderSelect('current_status', 'current_status', '–°—Ç–∞—Ç—É—Å')}
              
              <div className="form-group">
                <label className="form-label">
                  {formData.current_status === 'DEAD' ? '–î–∞—Ç–∞ —Å–º–µ—Ä—Ç–∏' : '–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞'}
                </label>
                <DateValidation
                  name="last_contact_date"
                  label=""
                  value={formData.last_contact_date}
                  onChange={handleChange}
                  tooltip="–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 15 —á–∏—Å–ª–æ –º–µ—Å—è—Ü–∞, –µ—Å–ª–∏ —Ç–æ—á–Ω–∞—è –¥–∞—Ç–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞"
                />
              </div>
            </div>
          </div>
        )

      case 'patient-basic':
        return (
          <>
            <div className="card">
              <h3>–ö–æ–¥ –ø–∞—Ü–∏–µ–Ω—Ç–∞ –∏ –¥–∞—Ç–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è</h3>
              <div className="grid grid-2">
                <div className="form-group">
                  <label className="form-label">–ö–æ–¥ –ø–∞—Ü–∏–µ–Ω—Ç–∞</label>
                  <input
                    type="text"
                    name="patient_code"
                    value={formData.patient_code}
                    onChange={handleChange}
                    className="form-input"
                    placeholder="–í–≤–µ–¥–∏—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ –ø–∞—Ü–∏–µ–Ω—Ç–∞"
                  />
                </div>
                
                <div className="form-group">
                  <label className="form-label">–î–∞—Ç–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è</label>
                  <DateValidation
                    name="date_filled"
                    label=""
                    value={formData.date_filled}
                    onChange={handleChange}
                    tooltip="–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 15 —á–∏—Å–ª–æ –º–µ—Å—è—Ü–∞, –µ—Å–ª–∏ —Ç–æ—á–Ω–∞—è –¥–∞—Ç–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞"
                  />
                </div>
              </div>
            </div>

            <div className="card">
              <h3>–ë–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞</h3>
              
              <div className="grid grid-2">
                <div className="form-group">
                  <label className="form-label">–ü–æ–ª<span className="required">*</span></label>
                  <select name="gender" value={formData.gender} onChange={handleChange} className="form-select" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
                    <option value="–º">–ú—É–∂—Å–∫–æ–π</option>
                    <option value="–∂">–ñ–µ–Ω—Å–∫–∏–π</option>
                  </select>
                </div>

                <DateValidation
                  name="birth_date"
                  label="–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è"
                  value={formData.birth_date}
                  onChange={handleChange}
                  validationRules={dateValidationRules.birth_date || []}
                  otherDates={formData}
                  tooltip="–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 15 —á–∏—Å–ª–æ –º–µ—Å—è—Ü–∞, –µ—Å–ª–∏ —Ç–æ—á–Ω–∞—è –¥–∞—Ç–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞"
                />

                <div className="form-group">
                  <label className="form-label">–†–æ—Å—Ç (—Å–º)</label>
                  <input
                    type="number"
                    name="height"
                    value={formData.height}
                    onChange={handleChange}
                    className="form-input"
                    min="50"
                    max="250"
                  />
                </div>

                <div className="form-group">
                  <label className="form-label">–í–µ—Å –Ω–∞ –Ω–∞—á–∞–ª–æ –ª–µ—á–µ–Ω–∏—è (–∫–≥)</label>
                  <input
                    type="number"
                    name="weight"
                    value={formData.weight}
                    onChange={handleChange}
                    className="form-input"
                    min="20"
                    max="300"
                  />
                </div>
              </div>

              {renderMultiSelect('comorbidities', 'comorbidities', '–°–æ–ø—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è')}

              {renderSelect('smoking_status', 'smoking_status', '–°—Ç–∞—Ç—É—Å –∫—É—Ä–µ–Ω–∏—è')}
            </div>
          </>
        )

      case 'diagnosis-alk':
        return (
          <>
            <div className="card">
              <h3>–î–∏–∞–≥–Ω–æ–∑</h3>
              
              <div className="grid grid-2">
                <DateValidation
                  name="initial_diagnosis_date"
                  label="–î–∞—Ç–∞ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –¥–∏–∞–≥–Ω–æ–∑–∞"
                  value={formData.initial_diagnosis_date}
                  onChange={handleChange}
                  tooltip="–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 15 —á–∏—Å–ª–æ –º–µ—Å—è—Ü–∞, –µ—Å–ª–∏ —Ç–æ—á–Ω–∞—è –¥–∞—Ç–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞"
                />

                <TNMSelect
                  name="tnm_stage"
                  label="–°—Ç–∞–¥–∏—è TNM (8-—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è)"
                  value={formData.tnm_stage}
                  onChange={handleChange}
                  options={dictionaries.tnm_stage || []}
                />

                <div className="form-group">
                  <label className="form-label">
                    –î–∞—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –º–µ—Ç–∞—Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è 
                    <span className="form-help">(–∑–∞–ø–æ–ª–Ω—è—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è)</span>
                  </label>
                  <DateValidation
                    name="metastatic_disease_date"
                    label=""
                    value={formData.metastatic_disease_date}
                    onChange={handleChange}
                    tooltip="–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 15 —á–∏—Å–ª–æ –º–µ—Å—è—Ü–∞, –µ—Å–ª–∏ —Ç–æ—á–Ω–∞—è –¥–∞—Ç–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞"
                  />
                </div>

                {renderSelect('histology', 'histology', '–ì–∏—Å—Ç–æ–ª–æ–≥–∏—è')}
              </div>
            </div>

            <div className="card">
              <h3>ALK –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h3>
              
              <div className="grid grid-2">
                <DateValidation
                  name="alk_diagnosis_date"
                  label="–î–∞—Ç–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ ALK —Ç—Ä–∞–Ω—Å–ª–æ–∫–∞—Ü–∏–∏"
                  value={formData.alk_diagnosis_date}
                  onChange={handleChange}
                  validationRules={dateValidationRules.alk_diagnosis_date || []}
                  otherDates={formData}
                  tooltip="–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 15 —á–∏—Å–ª–æ –º–µ—Å—è—Ü–∞, –µ—Å–ª–∏ —Ç–æ—á–Ω–∞—è –¥–∞—Ç–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞"
                />

                {renderSelect('alk_fusion_variant', 'alk_fusion_variant', '–í–∞—Ä–∏–∞–Ω—Ç ALK-—Ñ—É–∑–∏–∏')}
                {renderSelect('tp53_comutation', 'yes_no_unknown', '–ö–æ-–º—É—Ç–∞—Ü–∏—è TP53')}
                {renderSelect('ttf1_expression', 'yes_no_unknown', '–≠–∫—Å–ø—Ä–µ—Å—Å–∏—è TTF-1')}
              </div>

              {renderMultiSelect('alk_methods', 'alk_methods', '–ú–µ—Ç–æ–¥ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏')}
            </div>
          </>
        )

      case 'previous-therapy':
        return (
          <div className="card">
            <h3>–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å–∏—Å—Ç–µ–º–Ω–∞—è —Ç–µ—Ä–∞–ø–∏—è</h3>
            
            <div className="form-group">
              <label className="checkbox-label">
                <input
                  type="checkbox"
                  name="no_previous_therapy"
                  checked={formData.no_previous_therapy}
                  onChange={handleChange}
                />
                <span>–ù–µ –±—ã–ª–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Ç–µ—Ä–∞–ø–∏–∏</span>
              </label>
            </div>

            {!formData.no_previous_therapy && (
              <>
                <div className="form-group">
                  <label className="checkbox-label">
                    <input
                      type="checkbox"
                      name="had_previous_therapy"
                      checked={formData.had_previous_therapy}
                      onChange={handleChange}
                    />
                    <span>–ë—ã–ª–∞ –ø—Ä–µ–¥—ã–¥—É—â–∞—è —Ç–µ—Ä–∞–ø–∏—è</span>
                  </label>
                </div>

                {formData.had_previous_therapy && (
                  <>
                    {renderMultiSelect('previous_therapy_types', 'previous_therapy_types', '–¢–∏–ø –ª–µ—á–µ–Ω–∏—è')}
                    
                    <div className="grid grid-2">
                      <DateValidation
                        name="previous_therapy_start_date"
                        label="–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞"
                        value={formData.previous_therapy_start_date}
                        onChange={handleChange}
                      />

                      <DateValidation
                        name="previous_therapy_end_date"
                        label="–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è"
                        value={formData.previous_therapy_end_date}
                        onChange={handleChange}
                        validationRules={dateValidationRules.previous_therapy_end_date || []}
                        otherDates={formData}
                      />

                      {renderSelect('previous_therapy_response', 'response', '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç')}
                      {renderSelect('previous_therapy_stop_reason', 'previous_therapy_stop_reason', '–ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–µ–∫—Ä–∞—â–µ–Ω–∏—è')}
                    </div>
                  </>
                )}
              </>
            )}
          </div>
        )

      case 'alectinib-complete':
        return (
          <>
            <div className="card">
              <h3>–õ–µ—á–µ–Ω–∏–µ –∞–ª–µ–∫—Ç–∏–Ω–∏–±–æ–º</h3>
              
              <div className="grid grid-2">
                <DateValidation
                  name="alectinib_start_date"
                  label="–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ª–µ—á–µ–Ω–∏—è"
                  value={formData.alectinib_start_date}
                  onChange={handleChange}
                  tooltip="–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 15 —á–∏—Å–ª–æ –º–µ—Å—è—Ü–∞, –µ—Å–ª–∏ —Ç–æ—á–Ω–∞—è –¥–∞—Ç–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞"
                />

                {renderSelect('stage_at_alectinib_start', 'stage_at_alectinib_start', '–°—Ç–∞–¥–∏—è –Ω–∞ –º–æ–º–µ–Ω—Ç –Ω–∞—á–∞–ª–∞')}

                <div className="form-group">
                  <label className="form-label">ECOG —Å—Ç–∞—Ç—É—Å (0-4)</label>
                  <input
                    type="number"
                    name="ecog_at_start"
                    value={formData.ecog_at_start}
                    onChange={handleChange}
                    className="form-input"
                    min="0"
                    max="4"
                  />
                </div>
              </div>

              {renderMultiSelect('metastases_sites', 'metastases_sites', '–ú–µ—Ç–∞—Å—Ç–∞–∑—ã –Ω–∞ –º–æ–º–µ–Ω—Ç –Ω–∞—á–∞–ª–∞')}

              <div className="form-group">
                <label className="checkbox-label">
                  <input
                    type="checkbox"
                    name="cns_metastases"
                    checked={formData.cns_metastases}
                    onChange={handleChange}
                  />
                  <span>–ú–µ—Ç–∞—Å—Ç–∞–∑—ã –≤ –¶–ù–°</span>
                </label>
              </div>

              {formData.cns_metastases && (
                <div className="grid grid-3">
                  {renderSelect('cns_measurable', 'cns_measurable', '–ò–∑–º–µ—Ä—è–µ–º–æ—Å—Ç—å')}
                  {renderSelect('cns_symptomatic', 'cns_symptomatic', '–°–∏–º–ø—Ç–æ–º–∞—Ç–∏—á–Ω–æ—Å—Ç—å')}
                  {renderSelect('cns_radiotherapy', 'cns_radiotherapy', '–†–∞–¥–∏–æ—Ç–µ—Ä–∞–ø–∏—è')}
                </div>
              )}
            </div>

            <div className="card">
              <h3>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ —Ç–µ—Ä–∞–ø–∏—é –∞–ª–µ–∫—Ç–∏–Ω–∏–±–æ–º</h3>
              
              <div className="grid grid-2">
                {renderSelect('maximum_response', 'response', '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç')}
                
                <DateValidation
                  name="maximum_response_date"
                  label="–î–∞—Ç–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –Ω–∞–∏–±–æ–ª—å—à–µ–≥–æ –æ—Ç–≤–µ—Ç–∞"
                  value={formData.earliest_response_date}
                  onChange={handleChange}
                  tooltip="–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 15 —á–∏—Å–ª–æ –º–µ—Å—è—Ü–∞, –µ—Å–ª–∏ —Ç–æ—á–Ω–∞—è –¥–∞—Ç–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞"
                />

                {formData.cns_metastases && renderSelect('intracranial_response', 'response', '–ò–Ω—Ç—Ä–∞–∫—Ä–∞–Ω–∏–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç')}
              </div>
            </div>

            <div className="card">
              <h3>–ü—Ä–æ–≥—Ä–µ—Å—Å–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
              
              <div className="grid grid-2">
                {renderSelect('progression_during_alectinib', 'progression_type', '–ü—Ä–æ–≥—Ä–µ—Å—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ –≤—Ä–µ–º—è –ª–µ—á–µ–Ω–∏—è')}
                
                {formData.progression_during_alectinib && formData.progression_during_alectinib !== 'NONE' && (
                  <>
                    {renderSelect('local_treatment_at_progression', 'local_treatment_at_progression', '–õ–æ–∫–∞–ª—å–Ω–æ–µ –ª–µ—á–µ–Ω–∏–µ –ø—Ä–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—Ä–æ–≤–∞–Ω–∏–∏')}
                    
                    <DateValidation
                      name="progression_date"
                      label="–î–∞—Ç–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—Ä–æ–≤–∞–Ω–∏—è"
                      value={formData.progression_date}
                      onChange={handleChange}
                      tooltip="–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 15 —á–∏—Å–ª–æ –º–µ—Å—è—Ü–∞, –µ—Å–ª–∏ —Ç–æ—á–Ω–∞—è –¥–∞—Ç–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞"
                    />

                    <div className="form-group">
                      <label className="checkbox-label">
                        <input
                          type="checkbox"
                          name="continued_after_progression"
                          checked={formData.continued_after_progression}
                          onChange={handleChange}
                        />
                        <span>–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ª–µ—á–µ–Ω–∏—è –ø–æ—Å–ª–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—Ä–æ–≤–∞–Ω–∏—è</span>
                      </label>
                    </div>
                  </>
                )}
              </div>

              {formData.progression_during_alectinib && formData.progression_during_alectinib !== 'NONE' && 
                renderMultiSelect('progression_sites', 'metastases_sites', '–ú–µ—Å—Ç–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—Ä–æ–≤–∞–Ω–∏—è')
              }
            </div>

            <div className="card">
              <h3>–û–∫–æ–Ω—á–∞–Ω–∏–µ –ª–µ—á–µ–Ω–∏—è –∞–ª–µ–∫—Ç–∏–Ω–∏–±–æ–º</h3>
              
              <div className="grid grid-2">
                <DateValidation
                  name="alectinib_end_date"
                  label="–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è"
                  value={formData.alectinib_end_date}
                  onChange={handleChange}
                  validationRules={dateValidationRules.alectinib_end_date || []}
                  otherDates={formData}
                  tooltip="–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 15 —á–∏—Å–ª–æ –º–µ—Å—è—Ü–∞, –µ—Å–ª–∏ —Ç–æ—á–Ω–∞—è –¥–∞—Ç–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞"
                />

                {renderSelect('alectinib_stop_reason', 'alectinib_stop_reason', '–ü—Ä–∏—á–∏–Ω–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è')}

                <div className="form-group">
                  <label className="checkbox-label">
                    <input
                      type="checkbox"
                      name="had_treatment_interruption"
                      checked={formData.had_treatment_interruption}
                      onChange={handleChange}
                    />
                    <span>–ë—ã–ª–æ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –ª–µ—á–µ–Ω–∏—è</span>
                  </label>
                </div>

                <div className="form-group">
                  <label className="checkbox-label">
                    <input
                      type="checkbox"
                      name="had_dose_reduction"
                      checked={formData.had_dose_reduction}
                      onChange={handleChange}
                    />
                    <span>–°–Ω–∏–∂–µ–Ω–∏–µ –¥–æ–∑—ã –∏–∑-–∑–∞ –ù–Ø</span>
                  </label>
                </div>
              </div>

              {formData.had_treatment_interruption && (
                <div className="grid grid-2">
                  {renderSelect('interruption_reason', 'interruption_reason', '–ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è')}
                  
                  <div className="form-group">
                    <label className="form-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è (–º–µ—Å—è—Ü–µ–≤)</label>
                    <input
                      type="number"
                      name="interruption_duration_months"
                      value={formData.interruption_duration_months}
                      onChange={handleChange}
                      className="form-input"
                      min="0"
                      step="0.1"
                    />
                  </div>
                </div>
              )}
            </div>
          </>
        )

      case 'next-line':
        return (
          <div className="card">
            <h3>–°–ª–µ–¥—É—é—â–∞—è –ª–∏–Ω–∏—è —Ç–µ—Ä–∞–ø–∏–∏</h3>
            
            {renderMultiSelect('next_line_treatments', 'next_line_treatments', '–õ–µ—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –æ—Ç–º–µ–Ω—ã –∞–ª–µ–∫—Ç–∏–Ω–∏–±–∞')}
            
            <div className="grid grid-2">
              <DateValidation
                name="next_line_start_date"
                label="–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ —Å–ª–µ–¥—É—é—â–µ–π –ª–∏–Ω–∏–∏"
                value={formData.next_line_start_date}
                onChange={handleChange}
                tooltip="–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 15 —á–∏—Å–ª–æ –º–µ—Å—è—Ü–∞, –µ—Å–ª–∏ —Ç–æ—á–Ω–∞—è –¥–∞—Ç–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞"
              />

              <DateValidation
                name="next_line_end_date"
                label="–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è"
                value={formData.next_line_end_date}
                onChange={handleChange}
                tooltip="–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 15 —á–∏—Å–ª–æ –º–µ—Å—è—Ü–∞, –µ—Å–ª–∏ —Ç–æ—á–Ω–∞—è –¥–∞—Ç–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞"
              />

              <div className="form-group">
                <label className="checkbox-label">
                  <input
                    type="checkbox"
                    name="progression_on_next_line"
                    checked={formData.progression_on_next_line}
                    onChange={handleChange}
                  />
                  <span>–ü—Ä–æ–≥—Ä–µ—Å—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–π –ª–∏–Ω–∏–∏</span>
                </label>
              </div>

              {formData.progression_on_next_line && (
                <DateValidation
                  name="progression_on_next_line_date"
                  label="–î–∞—Ç–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—Ä–æ–≤–∞–Ω–∏—è"
                  value={formData.progression_on_next_line_date}
                  onChange={handleChange}
                  tooltip="–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 15 —á–∏—Å–ª–æ –º–µ—Å—è—Ü–∞, –µ—Å–ª–∏ —Ç–æ—á–Ω–∞—è –¥–∞—Ç–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞"
                />
              )}

              <div className="form-group">
                <label className="form-label">–í—Å–µ–≥–æ –ª–∏–Ω–∏–π –ø–æ—Å–ª–µ –∞–ª–µ–∫—Ç–∏–Ω–∏–±–∞</label>
                <input
                  type="number"
                  name="total_lines_after_alectinib"
                  value={formData.total_lines_after_alectinib}
                  onChange={handleChange}
                  className="form-input"
                  min="0"
                />
              </div>
            </div>
          </div>
        )

      default:
        return null
    }
  }

  if (loading) {
    return <div className="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  }

  return (
    <div className="patient-form-page-new">
      <div className="form-layout">
        <PatientFormSidebar 
          currentSection={currentSection}
          onSectionChange={setCurrentSection}
          sections={sections}
        />
        
        <div className="form-content">
          <div className="form-header">
            <div className="header-info">
              <h2>{isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞' : '–ù–æ–≤—ã–π –ø–∞—Ü–∏–µ–Ω—Ç'}</h2>
              {isEdit && (
                <div className="auto-save-status">
                  <span className="save-indicator">üíæ</span>
                  –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ
                </div>
              )}
            </div>
            <button onClick={() => navigate('/patients')} className="btn btn-secondary">
              –ó–∞–∫—Ä—ã—Ç—å
            </button>
          </div>

          {/* Persistent Patient Info Header */}
          {(formData.patient_code || formData.tnm_stage || formData.current_status) && (
            <div className="patient-info-header">
              {formData.patient_code && (
                <div className="info-item">
                  <span className="info-label">–ö–æ–¥ –ø–∞—Ü–∏–µ–Ω—Ç–∞:</span>
                  <span className="info-value">{formData.patient_code}</span>
                </div>
              )}
              {formData.tnm_stage && (
                <div className="info-item">
                  <span className="info-label">–°—Ç–∞–¥–∏—è:</span>
                  <span className="info-value">{formData.tnm_stage}</span>
                </div>
              )}
              {formData.current_status && (
                <div className="info-item">
                  <span className="info-label">–°—Ç–∞—Ç—É—Å:</span>
                  <span className={`info-value status-${formData.current_status?.toLowerCase()}`}>
                    {formData.current_status === 'ALIVE' ? '–ñ–∏–≤' : 
                     formData.current_status === 'DEAD' ? '–£–º–µ—Ä' :
                     formData.current_status === 'LOST_TO_FOLLOWUP' ? '–£—à–µ–ª –∏–∑ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è' :
                     formData.current_status}
                  </span>
                </div>
              )}
            </div>
          )}

          {error && (
            <div className="alert alert-error">{error}</div>
          )}

          <form onSubmit={handleSubmit}>
            {renderSection()}

            <div className="form-actions">
              <button type="submit" className="btn btn-primary" disabled={saving}>
                {saving ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : 
                 (sections.findIndex(s => s.id === currentSection) < sections.length - 1) ? 
                 '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –¥–∞–ª–µ–µ' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'}
              </button>
              <button 
                type="button" 
                onClick={() => navigate('/patients')} 
                className="btn btn-secondary"
                disabled={saving}
              >
                –û—Ç–º–µ–Ω–∞
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  )
}

export default PatientFormPageNew
